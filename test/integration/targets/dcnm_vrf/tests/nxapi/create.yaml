---
- debug: msg="START connection={{ ansible_connection }}/create.yaml"

- name: Verify if fabric - vxlan-shrishail-green-field is deployed.
  dcnm_rest:
    method: GET
    path: /rest/control/fabrics/vxlan-shrishail-green-field
  ignore_errors: yes
  register: result

- assert:
    that:
      - 'result.response|length > 0'

- name: setup - remove the vrf
  dcnm_rest: &rm
    method: DELETE
    path: /rest/top-down/fabrics/vxlan-shrishail-green-field/vrfs/ansible-vrf-1
  ignore_errors: yes

- name: Create a VRF - ansible-vrf-1 under fabric vxlan-shrishail-green-field
  dcnm_vrf: &conf1
    action: create
    fabric: vxlan-shrishail-green-field
    vrf_name: ansible-vrf-1
    vrf_id: 900100
  register: result

- assert:
    that:
      - 'result.changed == true'
      - 'result.response|length == 0'

- name: conf1 - Idempotence
  dcnm_vrf: *conf1
  register: result

- assert:
    that:
      - 'result.changed == false'
      - 'result.response|length == 0'

- name: Create a VRF - ansible-vrf-2 under fabric vxlan-shrishail-green-field but use existing vrf_id
  dcnm_vrf:
    action: create
    fabric: vxlan-shrishail-green-field
    vrf_name: ansible-vrf-2
    vrf_id: 900100
  register: result
  ignore_errors: yes

- assert:
    that:
      - 'result.changed == false'
      - '"VRF ID is already in use" in result.msg'

- name: cleanup - remove the vrf
  dcnm_rest:
    method: DELETE
    path: /rest/top-down/fabrics/vxlan-shrishail-green-field/vrfs/ansible-vrf-1
  register: result

- assert:
    that:
      - 'result.changed == false'
      - 'result.response|length == 0'

- debug: msg="END connection={{ ansible_connection }}/agg.yaml"
